const assert = require("node:assert/strict");

db = connect("mongodb://localhost/opcua");

db.disableFreeMonitoring();

result = db.data.findOne(
    { _id: "integration-tests" },
    {
        shouldBeMissing: { $type: "$alreadyPresent" },
        state: "$val.State",
        theAnswer: "$val.theAnswer",
        timeDiff: {
            $abs: {
                $subtract: [
                    { $dateFromString: { dateString: "$val.CurrentTime" } },
                    { $dateFromString: { dateString: "$val.StartTime" } }
                ]
            }
        },
        timestampDiff: {
            $dateDiff: {
                startDate: "$ts.State",
                endDate: "$$NOW",
                unit: "millisecond"
            }
        },
        ageRecord: "$recordAgeForTags",
    }
);

print(EJSON.stringify(result));

assert.equal(result.shouldBeMissing, "missing");

assert.equal(result.state, 0);

assert.equal(result.theAnswer, 42);

assert.ok(result.timeDiff > 0);

assert.ok(result.timestampDiff > 0);

assert.equal(result.ageRecord.length, 2);
assert.ok(result.ageRecord.includes("SecondsTillShutdown"));
assert.ok(result.ageRecord.includes("ShutdownReason"));
