<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Testing frontend</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
    integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/centrifuge/2.8.4/centrifuge.min.js"
    integrity="sha512-aOW5Alk4Adgb8UA4irUfbLsJXKpUDeLFWrFGQJ54HF2tp2QIZPC2p2spPD4i6pUNOVbDO4qa4QTcPQDnHBlcbw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
  <div>
    <label>Centrifugo URL: <input type="text" size="50" id="url-input"></label>
    <input type="button" value="Connect" id="connect-button">
    <span id="connect-status">not connected</span>
  </div>

  <div>
    <label>Channel: <input type="text" id="channel-input"></label>
    <label>Data: <input type="text" value="null" size="80" id="data-input"></label>
    <input type="button" value="Subscribe" id="subscribe-button">
    <input type="button" value="Unsubscribe" id="unsubscribe-button">
    <span id="subscription-status">not subscribed</span>
  </div>

  <ol start="0" id="publication"></ol>

  <script>
    var centrifuge;
    var subscription;

    $("#connect-button").click(function () {
      centrifuge = new Centrifuge($("#url-input").val(), { debug: true });
      const connectStatus = $("#connect-status");
      centrifuge.on("connect", function (context) {
        connectStatus.text("connected");
      });
      centrifuge.on("disconnect", function (context) {
        connectStatus.text("disconnected");
      });
      centrifuge.connect();
    });

    $("#subscribe-button").click(function () {
      const data = JSON.parse($("#data-input").val())
      const publication = $("#publication");
      publication.empty()
      data.nodes.forEach(() => {
        publication.append(document.createElement("li"))
      });
      subscription = centrifuge.subscribe($("#channel-input").val(), function (message) {
        $.each(message.data, function (key, value) {
          publication.children().get(parseInt(key)).innerText = value
        })
      }, { data });
      $("#unsubscribe-button").click(function () {
        subscription.unsubscribe();
      });
      const subscriptionStatus = $("#subscription-status")
      subscription.on("subscribe", function (context) {
        subscriptionStatus.text("subscribed");
      });
      subscription.on("unsubscribe", function (context) {
        subscriptionStatus.text("unsubscribed");
      });
    });

  </script>
</body>

</html>
