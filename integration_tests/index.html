<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Testing frontend</title>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
      integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/centrifuge/2.8.4/centrifuge.min.js"
      integrity="sha512-aOW5Alk4Adgb8UA4irUfbLsJXKpUDeLFWrFGQJ54HF2tp2QIZPC2p2spPD4i6pUNOVbDO4qa4QTcPQDnHBlcbw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
  </head>

  <body>
    <div>
      <label>
        Centrifugo URL: <input type="text" size="50" id="url-input" />
      </label>
      <input type="button" value="Connect" id="connect-button" />
      <span id="connect-status">not connected</span>
    </div>

    <div>
      <label>Channel: <input type="text" id="channel-input" /></label>
      <label>
        Data: <input type="text" value="null" size="80" id="data-input" />
      </label>
      <input type="button" value="Subscribe" id="subscribe-button" />
      <input type="button" value="Unsubscribe" id="unsubscribe-button" />
      <span id="subscription-status">not subscribed</span>
    </div>

    <div>
      <label
        >Heartbeat channel: <input type="text" id="heartbeat-channel-input"
      /></label>
      <input type="button" value="Subscribe" id="heartbeat-subscribe-button" />
      <input
        type="button"
        value="Unsubscribe"
        id="heartbeat-unsubscribe-button"
      />
      <span id="heartbeat-subscription-status">not subscribed</span>
    </div>

    <h5>OPC-UA data</h5>
    <ol start="0" id="publication"></ol>

    <table>
      <caption>
        Heartbeat publications
      </caption>
      <thead>
        <tr>
          <th>Status</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody id="heartbeat-publications"></tbody>
    </table>

    <script>
      var centrifuge
      var subscription

      $("#connect-button").click(() => {
        centrifuge = new Centrifuge($("#url-input").val(), { debug: true })
        const connectStatus = $("#connect-status")
        centrifuge.on("connect", (context) => {
          connectStatus.text("connected")
        })
        centrifuge.on("disconnect", (context) => {
          connectStatus.text("disconnected")
        })
        centrifuge.connect()
      })

      $("#subscribe-button").click(() => {
        const data = JSON.parse($("#data-input").val())
        const publication = $("#publication")
        publication.empty()
        data.nodes.forEach(() => {
          publication.append(document.createElement("li"))
        })
        subscription = centrifuge.subscribe(
          $("#channel-input").val(),
          (message) => {
            $.each(message.data, (key, value) => {
              publication.children().get(parseInt(key)).innerText = value
            })
          },
          { data }
        )
        $("#unsubscribe-button").click(() => {
          subscription.unsubscribe()
        })
        const subscriptionStatus = $("#subscription-status")
        subscription.on("subscribe", () => {
          subscriptionStatus.text("subscribed")
        })
        subscription.on("unsubscribe", () => {
          subscriptionStatus.text("unsubscribed")
        })
      })

      $("#heartbeat-subscribe-button").click(() => {
        const $tbody = $("#heartbeat-publications").empty()
        const subscription = centrifuge.subscribe(
          $("#heartbeat-channel-input").val(),
          (message) => {
            const $tr = $("<tr>").appendTo($tbody)
            $("<td>")
              .attr("data-value-for-key", "status")
              .text(message.data.status)
              .appendTo($tr)
            $("<td>")
              .attr("data-value-for-key", "description")
              .text(message.data.description)
              .appendTo($tr)
          }
        )
        $("#heartbeat-unsubscribe-button").click(() => {
          subscription.unsubscribe()
        })
        const $subscriptionStatus = $("#heartbeat-subscription-status")
        subscription.on("subscribe", () => {
          $subscriptionStatus.text("subscribed")
        })
        subscription.on("unsubscribe", () => {
          $subscriptionStatus.text("unsubscribed")
        })
      })
    </script>
  </body>
</html>

<style>
  table,
  th {
    border-top: 1px solid black;
    border-bottom: 1px solid black;
    border-collapse: collapse;
  }
</style>
